(()=>{const e=(e,t=document)=>t.querySelector(e),t=(e,t=document)=>[...t.querySelectorAll(e)],a={token:null,deviceId:null,prizes:[]};t(".tab-btn").forEach((e=>{e.addEventListener("click",(()=>{t(".tab-btn").forEach((e=>e.classList.remove("active"))),e.classList.add("active");const a=e.dataset.tab;t(".tab").forEach((e=>e.classList.remove("active"))),document.querySelector("#tab-"+a).classList.add("active")}))}));!function(){let e=localStorage.getItem("deviceId");e||(e=crypto.randomUUID(),localStorage.setItem("deviceId",e)),a.deviceId=e}();const n={normal:"/animations/normal.mp4",common:"/animations/common.mp4",rare:"/animations/rare.mp4",superrare:"/animations/superrare.mp4"};async function o(t){const a=e("#rarity-anim");a.src=n[t]||n.normal,a.currentTime=0,a.classList.remove("hidden");try{await a.play()}catch(e){}return new Promise((e=>{const t=()=>{a.classList.add("hidden"),a.pause(),a.currentTime=0,a.removeEventListener("ended",t),e()};a.addEventListener("ended",t),setTimeout(t,65e3)}))}async function s(){const t=await fetch("/api/spins?deviceId="+encodeURIComponent(a.deviceId)),n=await t.json();e("#spins").textContent=null!=n.spins?n.spins:0}async function i(){const t=await fetch("/api/my-collection?deviceId="+encodeURIComponent(a.deviceId)),n=await t.json(),o=e("#collection-list");o.innerHTML="";for(const e of n){const t=document.createElement("div");t.className="card",t.innerHTML=`<h4>${e.title}</h4>
                        <time>${new Date(e.obtained_at).toLocaleString()}</time>
                        <video src="${e.video}" controls playsinline></video>`,o.appendChild(t)}}s(),i();let r=!1;e("#btn-roll").addEventListener("click",async()=>{if(r)return;r=!0;try{const t=await fetch("/api/spin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:a.deviceId})}),n=await t.json();if(!n.ok)throw new Error(n.error||"spin failed");e("#spins").textContent=n.spins,await o(n.prize.rarity||"normal");const s=e("#result-video");s.src=n.prize.video||"",s.classList.remove("hidden");try{await s.play()}catch(e){}i()}catch(e){alert(e.message)}finally{r=!1}}),e("#btn-redeem").addEventListener("click",async()=>{const t=e("#serial").value.trim();if(!t)return;const n=await fetch("/api/redeem-serial",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t,deviceId:a.deviceId})}),o=await n.json();o.ok?(e("#serial").value="",e("#spins").textContent=o.spins,alert(`回数+${o.added} になりました！`)):alert(o.error||"redeem failed")});async function d(t){const n="serials"===t?e("#admin-password-serial"):e("#admin-password-inv"),o=n.value,s=await fetch("/api/admin/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o})}),i=await s.json();i.token?(a.token=i.token,localStorage.setItem("adminToken",i.token),"serials"===t?(e("#serials-login").classList.add("hidden"),e("#serials-area").classList.remove("hidden")):(e("#inventory-login").classList.add("hidden"),e("#inventory-area").classList.remove("hidden"),c())):alert(i.error||"login failed")}const l=localStorage.getItem("adminToken");l&&(a.token=l),t("button[data-login-target]").forEach((e=>e.addEventListener("click",(()=>d(e.dataset.loginTarget)))));async function c(){if(!a.token)return;const t=await fetch("/api/admin/prizes",{headers:{Authorization:"Bearer "+a.token}}),n=await t.json();a.prizes=n,m()}function u(e){const t=e.filter((e=>e.enabled)).reduce(((e,t)=>e+t.weight),0)||1;return e.map((e=>({...e,percent:Math.round(e.weight/t*1e3)/10})))}function m(){const n=e("#prize-body");if(!n)return;n.innerHTML="";const s=u(a.prizes);for(const e of s){const t=document.createElement("tr"),o=e.video_url||e.video_path?e.video_url||"/uploads/"+e.video_path:"";t.innerHTML=`
        <td><input data-k="title" data-id="${e.id}" value="${e.title}"></td>
        <td>
          <div style="display:flex; align-items:center; gap:8px;">
            <a href="${o}" target="_blank">${o?"動画を見る":"未設定"}</a>
            <input type="file" data-k="file" data-id="${e.id}" accept="video/*">
            <button data-upload="${e.id}">変更</button>
          </div>
        </td>
        <td><input data-k="percent" data-id="${e.id}" type="number" min="0" value="${e.enabled?e.percent:0}"></td>
        <td>
          <select data-k="rarity" data-id="${e.id}">
            <option value="normal" ${"normal"===e.rarity?"selected":""}>normal</option>
            <option value="common" ${"common"===e.rarity?"selected":""}>common</option>
            <option value="rare" ${"rare"===e.rarity?"selected":""}>rare</option>
            <option value="superrare" ${"superrare"===e.rarity?"selected":""}>superrare</option>
          </select>
        </td>
        <td class="center"><input data-k="enabled" data-id="${e.id}" type="checkbox" ${e.enabled?"checked":""}></td>
        <td><button data-del="${e.id}">削除</button></td>
      `,n.appendChild(t)}p(),n.querySelectorAll("input,button,select").forEach((t=>{t.dataset.del?t.addEventListener("click",(()=>{const e=+t.dataset.del;a.prizes=a.prizes.filter((t=>t.id!==e)),m()})):t.dataset.upload?t.addEventListener("click",(async()=>{const e=+t.dataset.upload,o=n.querySelector(`input[data-k="file"][data-id="${e}"]`);if(!o.files[0])return alert("動画ファイルを選択してください");const s=new FormData;s.append("video",o.files[0]);const i=await fetch("/api/admin/prizes/"+e+"/video",{method:"POST",headers:{Authorization:"Bearer "+a.token},body:s}),r=await i.json();r.ok?(alert("動画を差し替えました"),c()):alert(r.error||"アップロード失敗")})):t.addEventListener("input",p)}))}function p(){const t=e("#prize-body");if(!t)return;const a=[...t.querySelectorAll("tr")];let n=0;for(const e of a){const t=e.querySelector('input[data-k="enabled"]').checked,a=+e.querySelector('input[data-k="percent"]').value||0;t&&(n+=a)}e("#percent-sum").textContent=Math.round(10*n)/10}e("#add-prize")?.addEventListener("click",async()=>{if(!a.token)return alert("ログインしてください");const t=e("#new-title").value.trim(),n=e("#new-file").files[0],o=+e("#new-percent").value||0,s=e("#new-rarity").value;if(!t||!n)return alert("タイトルと動画を指定してください");const i=new FormData;i.append("title",t),i.append("percent",String(o)),i.append("rarity",s),i.append("enabled","1"),i.append("video",n);const r=await fetch("/api/admin/prizes/create",{method:"POST",headers:{Authorization:"Bearer "+a.token},body:i}),d=await r.json();d.ok?(alert("追加しました"),c(),e("#new-title").value="",e("#new-file").value="",e("#new-percent").value="0"):alert(d.error||"追加に失敗")}),e("#save-prizes")?.addEventListener("click",async()=>{if(!a.token)return alert("ログインしてください");const t=[...document.querySelectorAll("#prize-body tr")],n=[];for(const e of t){const t=+e.querySelector('input[data-k="title"]').dataset.id,o=e.querySelector('input[data-k="title"]').value,s=+e.querySelector('input[data-k="percent"]').value||0,i=e.querySelector('select[data-k="rarity"]').value,r=e.querySelector('input[data-k="enabled"]').checked?1:0;n.push({id:t,title:o,rarity:i,percent:s,enabled:r})}const o=n.filter((e=>e.enabled)).reduce(((e,t)=>e+t.percent),0);if(Math.round(10*o)/10!==100){if(!confirm(`合計が ${o}% です。自動で正規化して保存します。よろしいですか？`))return}const s=n.map((e=>({...e,weight:Math.round(e.percent)}))),i=new Map(a.prizes.map((e=>[e.id,e]))),r=[];for(const e of s)i.has(e.id)&&(r.push({_op:"update",id:e.id,title:e.title,rarity:e.rarity,weight:e.weight,enabled:e.enabled}),i.delete(e.id));const d=await fetch("/api/admin/prizes/bulk",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+a.token},body:JSON.stringify({items:r})}),l=await d.json();l.ok?(alert("保存しました"),c()):alert(l.error||"保存に失敗しました")});const h=localStorage.getItem("adminToken");h&&(a.token=h),t('button[data-login-target]').forEach((t=>t.addEventListener("click",(()=>d(t.dataset.loginTarget))))),document.addEventListener("click",(t=>{if("serials"===t.target?.dataset?.loginTarget||"inventory"===t.target?.dataset?.loginTarget){} })),e("#btn-issue-serial")&&e("#btn-issue-serial").addEventListener("click",async()=>{if(!a.token)return alert("ログインしてください");const t=+e("#serial-spins").value||1,n=e("#serial-code").value.trim(),o=e("#serial-reissue").checked;if(!n)return alert("シリアル番号を入力してください");const s=await fetch("/api/admin/serials/issue",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+a.token},body:JSON.stringify({spins:t,code:n,reissue:o})}),i=await s.json();i.ok?alert("発行しました: "+n):alert(i.error||"failed")})})();