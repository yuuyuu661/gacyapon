(()=>{const $=(s,r=document)=>r.querySelector(s),$$=(s,r=document)=>[...r.querySelectorAll(s)],state={token:null,deviceId:null,prizes:[]};$$('.tab-btn').forEach(b=>{b.addEventListener('click',()=>{$$('.tab-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');const t=b.dataset.tab;$$('.tab').forEach(s=>s.classList.remove('active'));$('#tab-'+t).classList.add('active');});});function ensureDeviceId(){let id=localStorage.getItem('deviceId');if(!id){id=crypto.randomUUID();localStorage.setItem('deviceId',id);}state.deviceId=id;}const rarityVideo={normal:'/animations/normal.mp4',common:'/animations/common.mp4',rare:'/animations/rare.mp4',superrare:'/animations/superrare.mp4'};const raritySfx={normal:'/sfx/normal.mp3',common:'/sfx/common.mp3',rare:'/sfx/rare.mp3',superrare:'/sfx/superrare.mp3'};function resetStage(){const v=$('#result-video');v.pause();v.currentTime=0;v.classList.add('hidden');v.src='';}async function playRarityAnim(kind){const v=$('#rarity-anim');const a=$('#rarity-sfx');v.src=rarityVideo[kind]||rarityVideo.normal;v.currentTime=0;v.classList.remove('hidden');let sfxTimer=null;const playSfx=()=>{a.src=raritySfx[kind]||raritySfx.normal;a.currentTime=0;a.loop=false;a.play().catch(()=>{});};const stopSfx=()=>{try{a.pause();a.currentTime=0;}catch(_){} if(sfxTimer){clearTimeout(sfxTimer);sfxTimer=null;}};const done=()=>{stopSfx();v.classList.add('hidden');v.pause();v.currentTime=0;v.removeEventListener('ended',done);};v.addEventListener('ended',done,{once:true});sfxTimer=setTimeout(playSfx,1000);setTimeout(done,65000);try{await v.play();}catch(_){}return new Promise(res=>{v.addEventListener('ended',()=>res(),{once:true});});}ensureDeviceId();async function refreshSpins(){const r=await fetch('/api/spins?deviceId='+encodeURIComponent(state.deviceId));const j=await r.json();$('#spins').textContent=j.spins??0;}refreshSpins();async function loadCollection(){const r=await fetch('/api/my-collection?deviceId='+encodeURIComponent(state.deviceId));const list=await r.json();const wrap=$('#collection-list');wrap.innerHTML='';for(const item of list){const card=document.createElement('div');card.className='card';card.innerHTML=`<h4>${item.title}</h4><time>${new Date(item.obtained_at).toLocaleString()}</time><video src="${item.video}" controls playsinline></video>`;wrap.appendChild(card);}}loadCollection();let rolling=false;$('#btn-roll').addEventListener('click',async()=>{if(rolling) return; rolling=true; try{const r=await fetch('/api/spin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({deviceId:state.deviceId})});const j=await r.json();if(!j.ok) throw new Error(j.error||'spin failed');$('#spins').textContent=j.spins;await playRarityAnim(j.prize.rarity||'normal');const v=$('#result-video');v.src=j.prize.video||'';v.classList.remove('hidden');const onEnded=()=>{v.removeEventListener('ended',onEnded);clearTimeout(safety);resetStage();};v.addEventListener('ended',onEnded,{once:true});const safety=setTimeout(onEnded,70000);try{await v.play();}catch(_){}loadCollection();}catch(e){alert(e.message);}finally{rolling=false;}});$('#btn-redeem').addEventListener('click',async()=>{const code=$('#serial').value.trim();if(!code) return;const r=await fetch('/api/redeem-serial',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code,deviceId:state.deviceId})});const j=await r.json();if(j.ok){$('#serial').value='';$('#spins').textContent=j.spins;alert(`回数+${j.added} になりました！`);}else{alert(j.error||'redeem failed');}});async function adminLogin(target){const field=target==='serials'?$('#admin-password-serial'):$('#admin-password-inv');const password=field.value;const r=await fetch('/api/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password})});const j=await r.json();if(j.token){state.token=j.token;localStorage.setItem('adminToken',j.token);if(target==='serials'){ $('#serials-login').classList.add('hidden'); $('#serials-area').classList.remove('hidden'); } else { $('#inventory-login').classList.add('hidden'); $('#inventory-area').classList.remove('hidden'); fetchPrizes(); }}else{alert(j.error||'login failed');}}const saved=localStorage.getItem('adminToken');if(saved){state.token=saved;}$$('button[data-login-target]').forEach(b=>b.addEventListener('click',()=>adminLogin(b.dataset.loginTarget)));async function fetchPrizes(){if(!state.token) return;const r=await fetch('/api/admin/prizes',{headers:{'Authorization':'Bearer '+state.token}});const arr=await r.json();state.prizes=arr;renderPrizes();}function percentFromWeights(list){const total=list.filter(p=>p.enabled).reduce((s,p)=>s+p.weight,0)||1;return list.map(p=>({...p,percent:Math.round((p.weight/total)*1000)/10}));}function renderPrizes(){const body=$('#prize-body');if(!body) return;body.innerHTML='';const withPct=percentFromWeights(state.prizes);for(const p of withPct){const tr=document.createElement('tr');const currentVideo=p.video_url||(p.video_path?('/uploads/'+p.video_path):'');tr.innerHTML=`<td><input data-k="title" data-id="${p.id}" value="${p.title}"></td><td><div style="display:flex;align-items:center;gap:8px;"><a href="${currentVideo}" target="_blank">${currentVideo?'動画を見る':'未設定'}</a><input type="file" data-k="file" data-id="${p.id}" accept="video/*"><button data-upload="${p.id}">変更</button></div></td><td><input data-k="percent" data-id="${p.id}" type="number" min="0" value="${p.enabled?p.percent:0}"></td><td><select data-k="rarity" data-id="${p.id}"><option value="normal" ${p.rarity==='normal'?'selected':''}>normal</option><option value="common" ${p.rarity==='common'?'selected':''}>common</option><option value="rare" ${p.rarity==='rare'?'selected':''}>rare</option><option value="superrare" ${p.rarity==='superrare'?'selected':''}>superrare</option></select></td><td class="center"><input data-k="enabled" data-id="${p.id}" type="checkbox" ${p.enabled?'checked':''}></td><td><button data-del="${p.id}">削除</button></td>`;body.appendChild(tr);}updatePercentSum();body.querySelectorAll('input,button,select').forEach(el=>{if(el.dataset.del){el.addEventListener('click',()=>{const id=+el.dataset.del;state.prizes=state.prizes.filter(x=>x.id!==id);renderPrizes();});}else if(el.dataset.upload){el.addEventListener('click',async()=>{const id=+el.dataset.upload;const input=body.querySelector(`input[data-k="file"][data-id="${id}"]`);if(!input.files[0]) return alert('動画ファイルを選択してください');const fd=new FormData();fd.append('video',input.files[0]);const r=await fetch('/api/admin/prizes/'+id+'/video',{method:'POST',headers:{'Authorization':'Bearer '+state.token},body:fd});const j=await r.json();if(j.ok){alert('動画を差し替えました');fetchPrizes();}else{alert(j.error||'アップロード失敗');}});}else{el.addEventListener('input',updatePercentSum);}});}function updatePercentSum(){const body=$('#prize-body');if(!body) return;const rows=[...body.querySelectorAll('tr')];let sum=0;for(const tr of rows){const en=tr.querySelector('input[data-k="enabled"]').checked;const pct=+tr.querySelector('input[data-k="percent"]').value||0;if(en) sum+=pct;}$('#percent-sum').textContent=Math.round(sum*10)/10;}$('#add-prize')?.addEventListener('click',async()=>{if(!state.token) return alert('ログインしてください');const title=$('#new-title').value.trim();const file=$('#new-file').files[0];const percent=+$('#new-percent').value||0;const rarity=$('#new-rarity').value;if(!title||!file) return alert('タイトルと動画を指定してください');const fd=new FormData();fd.append('title',title);fd.append('percent',String(percent));fd.append('rarity',rarity);fd.append('enabled','1');fd.append('video',file);const r=await fetch('/api/admin/prizes/create',{method:'POST',headers:{'Authorization':'Bearer '+state.token},body:fd});const j=await r.json();if(j.ok){alert('追加しました');fetchPrizes();$('#new-title').value='';$('#new-file').value='';$('#new-percent').value='0';}else{alert(j.error||'追加に失敗');}});$('#save-prizes')?.addEventListener('click',async()=>{if(!state.token) return alert('ログインしてください');const rows=[...document.querySelectorAll('#prize-body tr')];const edited=[];for(const tr of rows){const id=+tr.querySelector('input[data-k="title"]').dataset.id;const title=tr.querySelector('input[data-k="title"]').value;const percent=+tr.querySelector('input[data-k="percent"]').value||0;const rarity=tr.querySelector('select[data-k="rarity"]').value;const enabled=tr.querySelector('input[data-k="enabled"]').checked?1:0;edited.push({id,title,rarity,percent,enabled});}const ops=edited.map(x=>({_op:'update',id:x.id,title:x.title,rarity:x.rarity,weight:Math.round(x.percent),enabled:x.enabled}));const r=await fetch('/api/admin/prizes/bulk',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.token},body:JSON.stringify({items:ops})});const j=await r.json();if(j.ok){alert('保存しました');fetchPrizes();}else{alert(j.error||'保存に失敗しました');}});}
// --- issue serial (admin) ---
$('#btn-issue-serial')?.addEventListener('click', async ()=>{
  if(!state.token) return alert('ログインしてください');
  const spins = +$('#serial-spins').value || 1;
  const code = $('#serial-code').value.trim();
  const reissue = $('#serial-reissue').checked;
  if(!code) return alert('シリアル番号を入力してください');

  try {
    const r = await fetch('/api/admin/serials/issue', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+state.token },
      body: JSON.stringify({ code, spins, reissue })
    });
    const j = await r.json();
    if (j.ok) {
      alert('発行しました: ' + code + (j.reissued ? '（再発行）' : ''));
      $('#serial-code').value='';
    } else {
      alert(j.error || 'failed');
    }
  } catch (e) {
    alert('通信エラー: ' + e.message);
  }
});

})();
