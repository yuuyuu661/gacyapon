<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ã‚¬ãƒãƒ£ãƒãƒ³ v7.1</title>
<link rel="stylesheet" href="style.css" />
</head>

<body>

<h1>ğŸ ã‚¬ãƒãƒ£ãƒãƒ³ğŸ</h1>

<!-- ==========================================================
    â–¼ ã‚¿ãƒ–ãƒœã‚¿ãƒ³
========================================================== -->
<div class="tab-buttons">
  <button onclick="switchTab('gachaTab')">ã‚¬ãƒãƒ£ãƒãƒ³</button>
  <button onclick="switchTab('collectionTab')">ãƒã‚¤ã‚³ãƒ¬</button>
  <button onclick="switchTab('adminTab')">ç®¡ç†</button>
</div>

<!-- ==========================================================
    â–¼ ã‚¬ãƒãƒ£ãƒãƒ³ ã‚¿ãƒ–
========================================================== -->
<div id="gachaTab" class="tab-content active">

  <h2>ã‚¬ãƒãƒ£ã‚’å›ãã†ï¼</h2>

  <p>ğŸ« æ®‹ã‚Šå›æ•°ï¼š<span id="spinsDisplay">0</span></p>
<!-- â–¼ ã‚·ãƒªã‚¢ãƒ«å…¥åŠ›ã§å›æ•°è¿½åŠ  -->
<div style="margin-top:10px;">
    <input id="serialInput" type="text" placeholder="ã‚·ãƒªã‚¢ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="padding:10px;width:70%;border-radius:8px;border:1px solid #ccc;" />
    <button onclick="redeemSerial()">è¿½åŠ </button>
</div>

  <!-- ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆæ®‹æ•° -->
  <p id="completeText">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã¾ã§æ®‹ã‚Š -- ç¨®é¡ï¼</p>

  <!-- ã‚¬ãƒãƒ£ç­ä½“ç”»åƒ -->
  <img id="gachaImage" src="gachapon.png" />

  <!-- æ¼”å‡ºå‹•ç”» / æ™¯å“å‹•ç”»ãŒå…¥ã‚‹å ´æ‰€ -->
  <div id="videoArea"></div>

  <!-- ãƒœã‚¿ãƒ³ -->
  <button id="spinButton">å›ã™ï¼</button>
  <button id="spin10Button" class="spin10">10é€£ã§å›ã™ï¼</button>

</div>

<!-- ==========================================================
    â–¼ ãƒã‚¤ã‚³ãƒ¬ ã‚¿ãƒ–
========================================================== -->
<div id="collectionTab" class="tab-content">

  <h2>ğŸ“ ãƒã‚¤ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>

  <!-- superrare -->
  <div class="collection-block superrare-block">
    <div class="collection-title">SUPER RARE</div>
    <div class="collection-row" id="row-superrare"></div>
  </div>

  <!-- rare -->
  <div class="collection-block rare-block">
    <div class="collection-title">RARE</div>
    <div class="collection-row" id="row-rare"></div>
  </div>

  <!-- common -->
  <div class="collection-block common-block">
    <div class="collection-title">COMMON</div>
    <div class="collection-row" id="row-common"></div>
  </div>

  <!-- normal -->
  <div class="collection-block normal-block">
    <div class="collection-title">NORMAL</div>
    <div class="collection-row" id="row-normal"></div>
  </div>

</div>

<!-- ==========================================================
    â–¼ ç®¡ç†ç”»é¢ã‚¿ãƒ–ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼‰
========================================================== -->
<div id="adminTab" class="tab-content">

  <h2>ğŸ” ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³</h2>

  <div class="admin-box" id="adminLoginBox">
    <div class="input-row">
      <label>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" id="adminPass" />
    </div>
    <button onclick="adminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <!-- â–¼ ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ç®¡ç†UI -->
  <div id="adminPanel" style="display:none;">

    <h2>ğŸ« ã‚·ãƒªã‚¢ãƒ«ç•ªå· ç™ºè¡Œ</h2>
      <div class="admin-box">
      <div class="input-row">
        <label>ã‚·ãƒªã‚¢ãƒ«æ–‡å­—åˆ—ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="serialCustom" placeholder="ä¾‹ï¼šYUU-2025-LOVE" />
      </div>
      <div class="input-row">
        <label>è¿½åŠ ã™ã‚‹å›æ•°</label>
        <input type="number" id="serialSpins" placeholder="ä¾‹: 10" />
      </div>
      <button onclick="issueSerial()">ã‚·ãƒªã‚¢ãƒ«ç™ºè¡Œ</button>

      <h3>æœ€æ–°5ä»¶</h3>
      <div id="latestSerials"></div>
    </div>

    <h2>ğŸ“¦ æ™¯å“å…¥è·</h2>
    <div class="admin-box">

      <div class="input-row">
        <label>ãƒ¬ã‚¢åº¦</label>
        <select id="prizeRarity">
          <option value="superrare">SUPER RARE</option>
          <option value="rare">RARE</option>
          <option value="common">COMMON</option>
          <option value="normal">NORMAL</option>
        </select>
      </div>

      <div class="input-row">
        <label>æ™¯å“å‹•ç”»</label>
        <input type="file" id="prizeVideo" accept="video/*" />
      </div>

      <button onclick="uploadPrize()">ç™»éŒ²</button>

      <h3>ç™»éŒ²æ¸ˆã¿ä¸€è¦§</h3>
      <div id="prizeList"></div>
    </div>

  </div>

</div>


<!-- ==========================================================
    â–¼ Script
========================================================== -->
<script src="app.js"></script>

<script>
/* ã‚¿ãƒ–åˆ‡æ›¿ */
function switchTab(name) {
  document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
  document.getElementById(name).classList.add("active");
}

/* ==========================================================
    ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³
========================================================== */
let adminToken = "";

async function adminLogin() {
  const pass = document.getElementById("adminPass").value;
  const res = await fetch("/api/admin/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: pass })
  });

  const data = await res.json();
  if (!data.token) {
    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    return;
  }

  adminToken = data.token;
  document.getElementById("adminLoginBox").style.display = "none";
  document.getElementById("adminPanel").style.display = "block";
  loadPrizeList();
  loadLatestSerials();
}

/* ==========================================================
    ã‚·ãƒªã‚¢ãƒ«ç™ºè¡Œ
========================================================== */
async function issueSerial() {
  const spins = Number(document.getElementById("serialSpins").value);
  if (!spins || spins <= 0) {
    alert("å›æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const res = await fetch("/api/admin/serials/issue", {
    method: "POST",
    headers: { 
      "Content-Type": "application/json",
      "Authorization": "Bearer " + adminToken
    },
    body: JSON.stringify({ spins })
  });
  const data = await res.json();

  alert("ç™ºè¡Œã—ã¾ã—ãŸï¼ â†’ " + data.code);
  loadLatestSerials();
}

async function loadLatestSerials() {
  const res = await fetch("/api/admin/serials/latest", {
    headers: { Authorization: "Bearer " + adminToken }
  });

  const list = await res.json();
  const box = document.getElementById("latestSerials");

  box.innerHTML = list
    .map(x => `<div>${x.code}ï¼ˆ${x.spins}å›ï¼‰</div>`)
    .join("");
}

/* ==========================================================
    æ™¯å“ç™»éŒ²
========================================================== */
async function uploadPrize() {
  const file = document.getElementById("prizeVideo").files[0];
  if (!file) {
    alert("å‹•ç”»ã‚’é¸ã‚“ã§ãã ã•ã„");
    return;
  }

  const rarity = document.getElementById("prizeRarity").value;

  const form = new FormData();
  form.append("video", file);
  form.append("rarity", rarity);

  const res = await fetch("/api/admin/prizes/create", {
    method: "POST",
    headers: { Authorization: "Bearer " + adminToken },
    body: form
  });

  alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
  loadPrizeList();
}

async function loadPrizeList() {
  const res = await fetch("/api/admin/prizes", {
    headers: { Authorization: "Bearer " + adminToken }
  });
  const list = await res.json();

  const box = document.getElementById("prizeList");
  box.innerHTML = list.map(p => `
    <div style="margin:8px 0; border-bottom:1px solid #ccc;">
      <div>[${p.rarity}] ${p.video_path}</div>
      <button onclick="deletePrize(${p.id})">å‰Šé™¤</button>
    </div>
  `).join("");
}

async function deletePrize(id) {
  const res = await fetch("/api/admin/prizes/delete", {
    method: "POST",
    headers: { 
      "Content-Type":"application/json",
      "Authorization": "Bearer " + adminToken
    },
    body: JSON.stringify({ id })
  });
  loadPrizeList();
}
</script>

</body>
</html>
