<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ガチャポン v7.0</title>
  <link rel="stylesheet" href="./style.css">
</head>

<body>

  <!-- =============================
        タブメニュー
  ============================== -->
  <div style="text-align:center; margin-bottom:20px;">
    <button onclick="showTab('gachaTab')">ガチャポン</button>
    <button onclick="showTab('collectionTab')">マイコレクション</button>
    <button onclick="tryOpenAdmin()">管理</button>
  </div>

  <!-- =============================
        ▼ ガチャタブ
  ============================== -->
  <div id="gachaTab" class="tab active">

    <div id="gachaDisplay">
      <img id="gachaImage" src="./img/gachapon.png">
      <video id="gachaVideo" playsinline></video>
    </div>

    <div style="text-align:center; margin-top:10px;">
      <p>残り回数：<span id="spinCount">0</span></p>
      <button id="spinBtn">回す！</button>
      <button id="spin10Btn">10連で回す！</button>

      <p id="completeText" style="margin-top:10px;"></p>
    </div>

  </div>


  <!-- =============================
        ▼ マイコレクション
  ============================== -->
  <div id="collectionTab" class="tab">

    <!-- superrare -->
    <div class="rarity-block">
      <div class="rarity-title rarity-superrare">SUPER RARE</div>
      <div class="rarity-row" id="col-superrare"></div>
    </div>

    <!-- rare -->
    <div class="rarity-block">
      <div class="rarity-title rarity-rare">RARE</div>
      <div class="rarity-row" id="col-rare"></div>
    </div>

    <!-- common -->
    <div class="rarity-block">
      <div class="rarity-title rarity-common">COMMON</div>
      <div class="rarity-row" id="col-common"></div>
    </div>

    <!-- normal -->
    <div class="rarity-block">
      <div class="rarity-title rarity-normal">NORMAL</div>
      <div class="rarity-row" id="col-normal"></div>
    </div>

  </div>


  <!-- =============================
        ▼ 管理タブ（パスワード後に表示）
  ============================== -->
  <div id="adminTab" class="tab">

    <div class="admin-section">
      <h3>レア度確率設定</h3>

      <div class="admin-row">
        <label>SuperRare</label>
        <input type="number" id="rate-superrare" value="2"> %
      </div>
      <div class="admin-row">
        <label>Rare</label>
        <input type="number" id="rate-rare" value="20"> %
      </div>
      <div class="admin-row">
        <label>Common</label>
        <input type="number" id="rate-common" value="50"> %
      </div>
      <div class="admin-row">
        <label>Normal</label>
        <input type="number" id="rate-normal" value="28"> %
      </div>

      <button id="saveRatesBtn">保存</button>
    </div>


    <!-- 景品入荷 -->
    <div class="admin-section">
      <h3>景品入荷（動画登録）</h3>

      <form id="prizeForm" enctype="multipart/form-data">
        <div class="admin-row">
          <label>レア度</label>
          <select id="prizeRarity">
            <option value="superrare">superrare</option>
            <option value="rare">rare</option>
            <option value="common">common</option>
            <option value="normal">normal</option>
          </select>
        </div>

        <input type="file" id="prizeVideo" accept="video/*" required>
        <button type="button" onclick="uploadPrize()">登録する</button>
      </form>
    </div>

    <!-- 景品一覧 -->
    <div class="admin-section">
      <h3>登録済みの景品一覧</h3>
      <div id="prizeList"></div>
    </div>

  </div>


  <!-- =============================
        JS
  ============================== -->
  <script src="./app.js"></script>

  <script>
    /* -----------------------------
        タブ切り替え
    ------------------------------ */
    function showTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    /* -----------------------------
        管理タブを開く（パスワード）
    ------------------------------ */
    function tryOpenAdmin() {
      const pass = prompt("管理者パスワードを入力してください");
      if (!pass) return;

      fetch("/api/admin/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pass })
      })
      .then(r => r.json())
      .then(json => {
        if (json.token) {
          localStorage.setItem("adminToken", json.token);
          showTab("adminTab");
          loadAdminPrizes();
          loadRarityRates();
        } else {
          alert("パスワードが違います！");
        }
      });
    }

    /* -----------------------------
        景品一覧読み込み
    ------------------------------ */
    async function loadAdminPrizes() {
      const token = localStorage.getItem("adminToken");
      if (!token) return;

      const res = await fetch("/api/admin/prizes", {
        headers: { "Authorization": "Bearer " + token }
      });
      const list = await res.json();

      const wrap = document.getElementById("prizeList");
      wrap.innerHTML = "";

      list.forEach(p => {
        const div = document.createElement("div");
        div.style.marginBottom = "10px";
        div.style.padding = "10px";
        div.style.border = "1px solid #ccc";
        div.style.borderRadius = "8px";
        div.style.background = "#fafafa";

        div.innerHTML = `
          <p>ID: ${p.id}</p>
          <p>レア度: ${p.rarity}</p>
          <video src="/uploads/${p.video_path}" width="150" muted></video>
          <br>
          <button onclick="deletePrize(${p.id})">削除</button>
        `;

        wrap.appendChild(div);
      });
    }

    /* -----------------------------
        景品アップロード
    ------------------------------ */
    async function uploadPrize() {
      const token = localStorage.getItem("adminToken");
      if (!token) return alert("管理者ログインが必要です");

      const form = new FormData();
      form.append("rarity", document.getElementById("prizeRarity").value);
      form.append("video", document.getElementById("prizeVideo").files[0]);

      const res = await fetch("/api/admin/prizes/create", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: form
      });
      const json = await res.json();

      if (json.ok) {
        alert("登録しました！");
        loadAdminPrizes();
      } else {
        alert("登録エラー");
      }
    }

    /* -----------------------------
        景品削除
    ------------------------------ */
    async function deletePrize(id) {
      const token = localStorage.getItem("adminToken");
      if (!token) return;

      const res = await fetch("/api/admin/prizes/delete", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ id })
      });
      const json = await res.json();
      if (json.ok) {
        alert("削除しました！");
        loadAdminPrizes();
      }
    }
  </script>

</body>
</html>
