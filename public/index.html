<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¬ãƒãƒ£ãƒãƒ³</title>

    <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    ğŸ ã‚¬ãƒãƒ£ãƒãƒ³
</header>

<!-- â–¼ ã‚¿ãƒ– -->
<div class="tab-buttons">
    <button class="tab-btn active" data-tab="gacha">ã‚¬ãƒãƒ£ãƒãƒ³</button>
    <button class="tab-btn" data-tab="collection">ãƒã‚¤ã‚³ãƒ¬</button>
    <button class="tab-btn" data-tab="admin">ç®¡ç†</button>
</div>

<!-- =====================================================
    â–¼ ã‚¬ãƒãƒ£ãƒãƒ³ç”»é¢
===================================================== -->
<div id="gacha" class="tab-content active">

    <h2>ã‚¬ãƒãƒ£ã‚’å›ãã†ï¼</h2>

    <!-- æ®‹ã‚Šå›æ•° -->
    <p>ğŸ”” æ®‹ã‚Šå›æ•°ï¼š<span id="spinsDisplay">0</span></p>

    <!-- ã‚·ãƒªã‚¢ãƒ«å…¥åŠ›ã§å›æ•°è¿½åŠ  -->
    <div class="serial-box">
        <input id="serialInput" placeholder="ã‚·ãƒªã‚¢ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
        <button onclick="redeemSerial()">è¿½åŠ </button>
    </div>

    <!-- ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆæ®‹æ•° -->
    <p id="completeText" class="complete-text">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã¾ã§æ®‹ã‚Š 0 ç¨®é¡ï¼</p>

    <!-- ã‚¬ãƒãƒ£ç­ä½“ -->
    <div class="gacha-area">
        <img id="gachaImage" class="gacha-img" src="gachapon.png" />
        <div id="videoArea"></div>
    </div>

    <!-- ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³ -->
    <div class="spin-buttons">
        <button id="spinButton" class="spin-btn">å›ã™ï¼</button>
        <button id="spin10Button" class="spin-btn pink">10é€£ã§å›ã™ï¼</button>
    </div>

</div>


<!-- =====================================================
    â–¼ ãƒã‚¤ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
===================================================== -->
<div id="collection" class="tab-content">

    <h2>ãƒã‚¤ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã„ã¤ã§ã‚‚å‹•ç”»å†ç”Ÿå¯èƒ½ï¼‰</h2>

    <div class="rarity-block super-block">
        <h3 class="rarity-title super-title">SUPER RARE</h3>
        <div id="row-superrare" class="rarity-row"></div>
    </div>

    <div class="rarity-block rare-block">
        <h3 class="rarity-title rare-title">RARE</h3>
        <div id="row-rare" class="rarity-row"></div>
    </div>

    <div class="rarity-block common-block">
        <h3 class="rarity-title common-title">COMMON</h3>
        <div id="row-common" class="rarity-row"></div>
    </div>

    <div class="rarity-block normal-block">
        <h3 class="rarity-title normal-title">NORMAL</h3>
        <div id="row-normal" class="rarity-row"></div>
    </div>

</div>


<!-- =====================================================
    â–¼ ç®¡ç†ç”»é¢ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§é–‹é–‰ï¼‰
===================================================== -->
<div id="admin" class="tab-content">

    <h2>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>

    <!-- ç®¡ç†ãƒ‘ã‚¹ -->
    <div class="admin-auth">
        <input id="adminPass" type="password" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
        <button id="adminLoginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
    <div id="adminPanel" style="display:none;">

        <!-- â˜… ãƒ¬ã‚¢åº¦ç¢ºç‡è¨­å®š -->
        <section class="admin-section">
            <h3>ğŸ² ãƒ¬ã‚¢åº¦ç¢ºç‡è¨­å®š</h3>
            <div class="rate-box">
                <label>superrare (%)ï¼š<input id="rateSuper" type="number" min="0"></label>
                <label>rare (%)ï¼š<input id="rateRare" type="number" min="0"></label>
                <label>common (%)ï¼š<input id="rateCommon" type="number" min="0"></label>
                <label>normal (%)ï¼š<input id="rateNormal" type="number" min="0"></label>
            </div>
            <button id="saveRateBtn">ä¿å­˜</button>
        </section>

        <!-- â˜… æ™¯å“ç™»éŒ² -->
        <section class="admin-section">
            <h3>ğŸ“¦ æ™¯å“å‹•ç”»ã®ç™»éŒ²</h3>

            <select id="prizeRarity">
                <option value="superrare">SUPER RARE</option>
                <option value="rare">RARE</option>
                <option value="common">COMMON</option>
                <option value="normal">NORMAL</option>
            </select>

            <input id="prizeFile" type="file" accept="video/*" />

            <button id="addPrizeBtn">ç™»éŒ²</button>

            <h4>ç™»éŒ²æ¸ˆã¿æ™¯å“ä¸€è¦§</h4>
            <div id="prizeList" class="prize-list"></div>
        </section>

        <!-- â˜… ã‚·ãƒªã‚¢ãƒ«ç™ºè¡Œ -->
        <section class="admin-section">
            <h3>ğŸ”‘ ã‚·ãƒªã‚¢ãƒ«ã‚³ãƒ¼ãƒ‰ç™ºè¡Œ</h3>

            <input id="serialWord" placeholder="å¥½ããªæ–‡å­—åˆ—ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šyuu2025ï¼‰">
            <input id="serialSpins" type="number" min="1" placeholder="ä»˜ä¸å›æ•°">

            <button id="issueSerialBtn">ç™ºè¡Œ</button>

            <h4>ç›´è¿‘ã®ç™ºè¡Œå±¥æ­´</h4>
            <div id="serialLog" class="serial-log"></div>
        </section>

    </div>

</div>


<script src="app.js"></script>

<script>
/* ==========================================================
    â–¼ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
========================================================== */
const tabs = document.querySelectorAll(".tab-btn");
const contents = document.querySelectorAll(".tab-content");

tabs.forEach(btn => {
    btn.addEventListener("click", () => {
        tabs.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        contents.forEach(c => c.classList.remove("active"));
        document.getElementById(btn.dataset.tab).classList.add("active");
    });
});

/* ==========================================================
    â–¼ ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³
========================================================== */
document.getElementById("adminLoginBtn").onclick = async () => {
    const pw = document.getElementById("adminPass").value;

    const res = await fetch("/api/admin/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ password: pw })
    });
    const data = await res.json();

    if (!data.ok) {
        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ï¼");
        return;
    }

    document.getElementById("adminPanel").style.display = "block";

    await loadAdminRates();
    await loadPrizeList();
    await loadSerialLogs();
};

/* ==========================================================
    â–¼ ãƒ¬ã‚¢åº¦ç¢ºç‡èª­ã¿è¾¼ã¿
========================================================== */
async function loadAdminRates() {
    const res = await fetch("/api/admin/rates");
    const rates = await res.json();

    rateSuper.value = rates.superrare;
    rateRare.value = rates.rare;
    rateCommon.value = rates.common;
    rateNormal.value = rates.normal;
}

/* ä¿å­˜ */
document.getElementById("saveRateBtn").onclick = async () => {
    const body = {
        superrare: Number(rateSuper.value),
        rare: Number(rateRare.value),
        common: Number(rateCommon.value),
        normal: Number(rateNormal.value)
    };

    const res = await fetch("/api/admin/rates", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
    });

    alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
};

/* ==========================================================
    â–¼ æ™¯å“ä¸€è¦§èª­ã¿è¾¼ã¿
========================================================== */
async function loadPrizeList() {
    const res = await fetch("/api/admin/prizes");
    const list = await res.json();

    prizeList.innerHTML = "";

    list.forEach(p => {
        const card = document.createElement("div");
        card.className = "prize-card";

        card.innerHTML = `
            <video src="${p.video_path}" muted></video>
            <p>${p.rarity}</p>
        `;

        prizeList.appendChild(card);
    });
}

/* ==========================================================
    â–¼ æ™¯å“ç™»éŒ²
========================================================== */
document.getElementById("addPrizeBtn").onclick = async () => {
    const file = prizeFile.files[0];
    const rarity = prizeRarity.value;

    if (!file) return alert("å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„");

    const fd = new FormData();
    fd.append("file", file);
    fd.append("rarity", rarity);

    const res = await fetch("/api/admin/prizes", {
        method: "POST",
        body: fd
    });

    const data = await res.json();

    if (!data.ok) {
        alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
        return;
    }

    alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
    loadPrizeList();
};

/* ==========================================================
    â–¼ ã‚·ãƒªã‚¢ãƒ«ãƒ­ã‚°èª­ã¿è¾¼ã¿
========================================================== */
async function loadSerialLogs() {
    const res = await fetch("/api/admin/serials");
    const logs = await res.json();

    serialLog.innerHTML = "";

    logs.forEach(s => {
        const div = document.createElement("div");
        div.textContent = `${s.code} / ${s.spins}å› / ${s.used ? "ä½¿ç”¨æ¸ˆ" : "æœªä½¿ç”¨"}${s.usedAt ? " / " + s.usedAt : ""}`;
        serialLog.appendChild(div);
    });
}

/* ==========================================================
    â–¼ ã‚·ãƒªã‚¢ãƒ«ç™ºè¡Œ
========================================================== */
document.getElementById("issueSerialBtn").onclick = async () => {
    const code = serialWord.value.trim();
    const spins = Number(serialSpins.value);

    if (!code || !spins) return alert("å…¥åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™");

    const res = await fetch("/api/admin/serials/issue", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ code, spins })
    });

    const data = await res.json();

    if (!data.ok) return alert("ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ");

    alert("ç™ºè¡Œã—ã¾ã—ãŸï¼");
    loadSerialLogs();
};
</script>

</body>
</html>
